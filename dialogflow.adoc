= Creating Conversations with DialogFlow
Ryan Schuetzler <rschuetzler@unomaha.edu>
v0.1, 2018-03-07
:imagesdir: ./images
:icons: font
:source-highlighter: rouge

Google provides access to its awesome human language recognition capabilities through a tool called DialogFlow (https://dialogflow.com/).
This tutorial walks through how to create a basic DialogFlow agent.

== Create your Agent

. Go to https://dialogflow.com
. Click the Go to Console button in the top right
+
.Click the Go to Console button
image::go-to-console.png[Go to console]

. Click "Create Agent" on the left.
+
.Click the "Create Agent" button
image::create-agent.png[Create agent]
. Name your agent at the top of the page. I have named mine Steve.
. In the Google Project section, select the option to create a new Google project. This will be how you deploy the application later.
+
.Create a new Google project
image::create-project.png[Create project]

. Leave the API Version slider to the left.
. When you're ready, click the "CREATE" button in the top right.

== Share your agent
In order to test your agent on the Google Homes in the Code Crush classroom, you need to share it with the person assigned to your Google Home.

. Click the gear next to your agent's name in the top left.
+
.Click the gear next to your agent's name
image::agent-settings.png[Agent settings]

. Go to the Share tab and enter the email address of the person you are assigned to.
. Add them as a Reviewer, then click ADD.
. Click SAVE at the top of the share page.

== Setting up Intents
Intents are DialogFlow's way of classifying what your users are trying to do when they talk.
Example intents might be:

- Greeting
- Check the weather
- Add a task
- Get directions

DialogFlow agents come with two default intents.
You are free to add to those, delete them, or modify them as you want.

- Click on the "Default Welcome Intent"

Notice that the Intent screen consists of 6 collapsable sections:

- *Contexts* keep track of what you are talking about. If you said "Play me some U2", the contexts could be "Playing music" and "Artist: U2". Then you could say "I want a different song," and knowing the context would allow your app to know you are referring to the music that is playing.
- *Events* are ways to trigger intents without user input.
- *Training phrases* are examples of things your users could say to trigger the intent. For a weather intent, it could include many different examples of how your users might ask about the weather.
- *Actions and parameters* specify _actions_, which are what your agent does in response to the intent, and _parameters_, which are extra data you are trying to use to complete the action.
- *Responses* are pre-programmed responses to the intent. 
- *Fulfillment* is how you get your agent to actually _do_ something besides talk in response to an intent.

Let's add some Training phrases so Google can learn when we want to trigger the Welcome Intent.

. Under the "Training phrases" section, click inside the "Add user expression" box.
. Enter the following lines, pressing "Enter" after each one:
.. Hi
.. Hello
.. Howdy
.. Sup
.. Yo
.. Good morning
. Click "SAVE" in the upper right corner of the page.
.. You should now see a small pop up notification in the bottom right that the agent was saved.
.. This will be followed by another notification that "Agent training started." This is the indication that Google has begun running its machine learning algorithms over your training phrases to learn how to classify user input.
.. You'll then see another notification: "Agent training completed." That means your agent is now ready for testing.
. Test your agent by typing in the test console on the right.
.. Type "Hi there" in the test console.
. When the agent responds, you will see a variety of information come through:
+
.Results from the DialogFlow console
image::dflow-console.png[DialogFlow Console]

.. *User Says* shows the message you input into the console
.. *Default response* shows the response generated by your agent. You can click "Play" to hear the response spoken by your agent.
.. *Intent* shows what intent was triggered by the input
.. *Action* shows the action that was triggered as a part of the intent
. Now let's add some more responses to our agent.
.. Under the Responses section, click the row that says "Enter a text response variant"
.. Enter a new response: "Howdy."
.. Click "SAVE" in the top right.
+
NOTE: If there is no Fulfillment generating a response, one of the responses from the Responses section will be randomly selected.

=== Create your own Intent
Now we'll create our own intent to allow users to tell our agent their name.

. Click the + next to Intents on the left.
. Enter a name for your intent at the top. Call it "Set name"
. Click to Add Training phrases
. Enter the following Training phrases. Feel free to replace the names I've entered with names of your own:
.. My name is Ryan.
.. Bill.
.. I'm Steve.
.. The name's Bond. James Bond.
. Now Click "Manage Parameters and Action" in the Action and parameters section.

=== Extracting parameters

Notice that as you enter the training phrases, DialogFlow has already started highlighting parts of your input. This is the system attempting to automatically identify what parameters we might want in the user input. Now we'll tell our agent what information we specifically need.

If you entered the training phrases above, you should have two pre-populated parameters: `given-name` and `last-name` (see <<action-section>>). This is from DialogFlow trying to guess what parameters you are providing from your training phrases. Sometimes it gets it right, and sometimes it gets it wrong. If it's wrong, you can correct it by deleting, adding, or renaming parameters.

.Action and parameters section
[#action-section]
image::action.png[Action and parameters]

Let's look at the parameters table that has been prepopulated. The first column shows a checkbox that allows us to select whether a certain parameter is required. For example, if you wanted a unit conversion intent, you would need to require at least two parameters: the unit to convert from, and the unit to convert to. You might have another optional parameter called quantity. If no quantity is provided, you could convert 1 "from" unit into "to" units. If a quantity is provided, you would perform the calculation with that value.

The parameter name is a programmer-friendly name we can use to reference the value provided by the user.

The Entity column references Entities, something we have not talked about yet. Thankfully, DialogFlow comes with a whole bunch of built-in Entities to match commonly used terms. The system-created entities begin with `@sys.`. If you click the "Enter entity" section in the last row and click the down arrow key on your keyboard, you can see some of the other examples of built-in entities. You can also create your own.

TIP: Entities tell DialogFlow what kinds of values to look for to fill a slot. The `@sys.given-name` default entity is populated with common given names in the language selected for your agent. If your students have uncommon given names, they may not match, and it might be helpful to create your own entity.

The Value column is where the user input is stored.

The Is List column allows you to specify that a user may have more than one of a parameter. If your intent was to add items to a grocery list, you would want users to be able to add more than one item at once, so you could specify a parameter called `item` and call it a list.

Prompts is where you can tell your agent to ask follow-up questions to get pieces of information. Prompts are only available for required parameters.


. Enter an action name of `intent.set_name`
. Check the box under "Required" for the `given-name` parameter. This tells the system that this intent will only be completed when a given name is entered.
. Now click "Define prompts..." on the `given-name` parameter.
+
NOTE: Prompts are a way to tell your agent how to ask for information from a user. They are especially useful if you have multiple required parameters. If your users give some of the parameters but not all, your agent will use the prompts to ask for the remaining information.
.. Type "Please state your name" in the Enter a prompt line.
. Click Save, wait for the "Training completed" notification, and test your agent in the test console on the right. Try to trigger the Set name intent. If you try to trigger the intent and it doesn't work, you may need to add a new training phrase.

=== Responding
Now that we have populated our `given-name` parameter, we want to use it to respond to our users.

. Click "Add Response" in the Responses section.
. In the "Enter a text response" box, type "Nice to meet you". This is an example of a generic response. We want to personalize our responses to use the provided name.
. After the "you" in nice to meet you, add a space and enter $.
.. This should open a pop-up window with a list of your parameters from above. Select the `$given-name` parameter.
. Click Save, wait for Training, and test your agent in the test console. Notice that if you now include a name in your message, the agent repeats the name back to you.

== Creating custom entities
Entities are how your DialogFlow agent recognizes what you are talking about. 
For many applications, the built-in entities are good enough.
There are built-in entities to match numbers, dates, music genres, currency names, and many others.
For a complete list, check out https://dialogflow.com/docs/reference/system-entities.

However, there may be times when you need to define your own entity.
One entity I have created is medication names.
If I want DialogFlow to recognize when users have entered the name of a medication, I first have to teach it what the medications are that I want to recognize.

We're going to create a new entity to recognize the names of programming languages so we can ask our users about their favorite language.

. Click the + next to Entities on the left.
. Type the name `programming-language` for the Entity. Entity names can be almost anything, but they can't include spaces.
. Leave the box checked for "Define synonyms." Synonyms are a way of telling DialogFlow that there is more than one way a user can be referring to the same entity. For example, "veggies" and "vegetables" would likely be referring to the same thing.
. Leave the box unchecked for "Allow automated expansion." For more on what automated expansion means, see the documentation: https://dialogflow.com/docs/entities.
. Let's add some programming languages. Enter the following as "reference values."
.. Python
.. C
.. C++
.. Ruby
.. Java
.. Javascript
. For Javascript, enter the following as synonyms:
.. Node.js
.. Node
.. Jquery
. Now add a new intent called "Set Favorite Language". Give it some training phrases and a response.
+
IMPORTANT: DialogFlow will only recognize values for custom entities that are included in the Entities list or as a synonym. If you have a favorite programming language that's not on the list, you need to add it. If you want to be able to match any programming language, you'll need to input the full list of languages (start here https://en.wikipedia.org/wiki/List_of_programming_languages).

== Context
Context is helpful for driving conversations with a conversational agent.
The context is how DialogFlow keeps track of what your users are talking about.
For example, let's say you wanted to create a smart home assistant to allow you to turn the lights on and off in your home.
If your user says "Turn on the lights in the living room," the agent could do that.
If the user then says "Now turn them off," your agent may not know what "them" refers to.
That is a part of the context of the conversation.
Humans learn to understand context without thinking about it, but with our agents we'll need to teach them explicitly.

We will use context to drive a short interview conversation.
We'll hijack context a bit to tell our agent what questions to ask.
Let's go back and start with our "Set name" intent.

Each intent has the option to include an input context and an output context.
Input context refers to the state of the user that would trigger the intent.
Output context is created after the intent is completed, and can be used to direct future conversation.
We will create chain of contexts to direct our users through a brief interview.

. Go to your "Set name" intent.
. Set the output context to `awaiting_programming_language`.
. Set the "lifespan" of the context to "1". The lifespan refers to how long the agent keeps track of this context. With a lifespan of 1 the `awaiting_programming_language` tag will stick to the user for 1 more message--just long enough to trigger the next conversation.
. Add a follow-up question to the end of the responses for "Set name": What is your favorite programming language?
. Save your changes.
. Open the "Set favorite language" intent.
. Add an input context of `awaiting_programming_language`.
. Add an output context of `awaiting_programming_language` with a lifespan of 0. This will get rid of that context for the user, which we want to do now that they have answered the question and triggered the "Set favorite language" intent.
. Set an output context of `awaiting_color` with a lifespan of 1.
. Add a follow-up question after your Programming language responses to ask "What's your favorite color?"
. Create a new intent called "Set Color" for users to enter their favorite color. Give it an input context of `awaiting_color`. Add training phrases for how people might indicate what their favorite color is, and create a new parameter to match the colors they might say. Create a response that repeats the color back to the user.

== Fulfillment
Fulfillment is where the real magic happens with a DialogFlow agent, but it takes a bit more programming than anything we've done so far.
Thankfully, we can get through the basics without ever leaving the DialogFlow console.

. Create a new intent called "Add numbers"
. Create some training phrases with different ways users could ask to add two numbers together. "What's 2.8 plus 12?" or "What do you get when you add 33 and 66?"
. Enter an action name of `add_numbers`
. Create two parameters, `number1` and `number2`, and have them match with the entity `@sys.number`.
. Make sure the entities in your training phrases are matched with the right parameters (they should be two different colors).
. In the Fulfillment section, turn on "Enable webhook call for this intent"
. Save your changes
. Go to the Fulfillment tab on the left.
. Enable the "Inline Editor"
. Put an extra line after line 46
. Put the following code in the space:
+
.add_numbers
[source,javascript]
----
'add_numbers': () => {
        var num1 = parameters["number1"];
        var num2 = parameters["number2"];
        var sum = num1 + num2;
        if (requestSource === googleAssistantRequest) {
        sendGoogleResponse("I got your sum right here: " + sum); // Send simple response to user
      } else {
        sendResponse("I got your sum right here: " + sum); // Send simple response to user
      }
    },
----

. Click DEPLOY
. Once deployment completes, you can test your new function by asking the test agent to add two numbers.

== Enable Small Talk
DialogFlow agents can be given the ability to do a bit of small talk, too.
This can help make the interactions with it feel a bit more natural.
To do this, go to the Small Talk section on the left menu, slide the slider to enable, and start customizing your agent's small talk.


== Deploy to Google Home
To test your app out on Google Home, click the "See how it works in Google Assistant" link in the test console. This will drop you in the simulator. There you can follow the same deployment steps as in the Trivia Game tutorial, including adding the Google Home person to your project (gears icon) and sharing the link with them. See <<trivia-game.adoc#deploy,the Trivia Game tutorial>>.

// To deploy our action to a Google Home, we'll need to go to the Actions console

// . Go to https://console.actions.google.com
// . If you see the name of your agent in your projects list, click it. If not, click + to add a new project.
// .. Click the box to Enter a name or choose a project.
// .. Select your agent from the list that pops up.
// . Click "Add Actions"
// . Click "BUILD" in the DialogFlow box. That should 

== Extra Activities

- Add platform-specific responses for one of your responses. Click the "+" icon next to Default to get started.
- Look under the integrations section for how to incorporate your agent into other messaging applications like Slack, Facebook Messenger, or Skype. Note that all of the integrations require developer accounts with the services you would like to integrate with.
TIP: You can even export your DialogFlow agent to an Alexa Skill.
- Import one of the Prebuilt Agents (under Prebuilt Agents on the left). This will create a new Agent with some prepopulated intents.
- Create an agent that speaks a different language by clicking the + next to "en" under your agent's name on the left.
- Check out the DialogFlow Docs (https://dialogflow.com/docs/) to learn about more things you can do with agents.
- Fill out more of the Small Talk.
- Add more intents with Webhooks in the Fulfillment viewer. Suggestions: Multiply or divide two numbers, find a way to add three numbers, or square one number.
- *Really advanced*: Figure out how to call another web service from the fulfillment app to get the weather forecast or look up stock prices.
